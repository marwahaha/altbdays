<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>altbdays</title>
    <script src="luxon.min.js"></script>
</head>
<style>
    body {
        margin: 20px;
        background-color: oldlace;
    }

    input {
        width: 120px;
    }
</style>

<body>
    <div>
        <span>birthday: </span>
        <input oninput="recalc()" id="input_year" type="number" placeholder="year">
        <input oninput="recalc()" id="input_month" type="number" placeholder="month (1-12)">
        <input oninput="recalc()" id="input_day" type="number" placeholder="day">
    </div>
    <div>
        <p>Alternative birthdays:</p>
        <ul id="hours"></ul>
        <ul id="days"></ul>
        <ul id="months"></ul>
    </div>
    <div>
        <a class="download" style="display: none" id="download" download="birthdays.ics"><button>Download calendar events</button></a>
    </div>
    <script>
        var YESTERDAY = luxon.DateTime.local().plus({ days: -1 });
        var HOURS_EL = document.getElementById("hours")
        var DAYS_EL = document.getElementById("days")
        var MONTHS_EL = document.getElementById("months")
        var ICS_FILE = null;

        var data = {
            'hours': {
                'ul': HOURS_EL,
                'name': 'hours',
                'multiplier': 10000,
            },
            'days': {
                'ul': DAYS_EL,
                'name': 'days',
                'multiplier': 1000,
            },
            'months': {
                'ul': MONTHS_EL,
                'name': 'months',
                'multiplier': 25,
            }
        }

        function createElement(unit, number) {
            span = document.createElement("span")
            span.className = "answer"
            span.id = "answer_" + unit + "_" + number;
            li = document.createElement("li")
            li.appendChild(span);
            li.innerHTML += " (" + number + " " + unit + ")";
            return li;
        }

        function clearElements() {
            var objs = [HOURS_EL, DAYS_EL, MONTHS_EL];
            for (var x = 0; x < objs.length; x++) {
                for (var i = objs[x].children.length - 1; i >= 0; i--) {
                    objs[x].removeChild(objs[x].children[0]);
                }
            }

        }

        function recalc() {
            y = document.getElementById("input_year").valueAsNumber;
            m = document.getElementById("input_month").valueAsNumber;
            d = document.getElementById("input_day").valueAsNumber;
            if (Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) {
                return;
            }

            clearElements();

            var icsString = ICS_PREFIX;
            var icsHash = null;
            for (a = 0; a < Object.keys(data).length; a++) {
                var curObj = data[Object.keys(data)[a]];
                var diff = YESTERDAY.diff(luxon.DateTime.local(y, m, d), curObj['name']).toObject();
                var diffValue = diff[Object.keys(diff)[0]];
                start = Math.floor(diffValue / curObj['multiplier']);

                for (i = start; i < start + 5; i++) {
                    val = curObj['multiplier'] * i;
                    bday = findBday(y, m, d, curObj['name'], val);
                    curObj['ul'].appendChild(createElement(curObj['name'], val));
                    el = document.getElementById("answer_" + curObj['name'] + "_" + val);
                    el.innerText = bday;
                    if (bday < YESTERDAY.toISODate()) {
                        el.parentElement.style.color = 'gray';
                    } else {
                        el.parentElement.style.color = '';
                    }
                    icsHash = Math.random().toString().substring(2);
                    icsString += buildIcsEventString(new Date(bday).toISOString(), val, curObj['name'], icsHash);
                }
            }

            // TODO: verify it makes the right events
            icsString += ICS_SUFFIX;
            buildIcsFileFromString(icsString);
            document.getElementById("download").style.display = "";
            document.getElementById("download").href = ICS_FILE;
        }
        function findBday(y, m, d, unit, number) {
            return luxon.DateTime.local(y, m, d).plus({ [unit]: number }).toISODate();
        }

        function convertDate(date) {
            output = date.split("T")[0];
            output = output.split("-");
            output = output.join("");
            return output;
        }

        var ICS_PREFIX =
            "BEGIN:VCALENDAR\n" +
            "CALSCALE:GREGORIAN\n" +
            "METHOD:PUBLISH\n" +
            "PRODID:-//Test Cal//EN\n" +
            "VERSION:2.0\n";

        var ICS_SUFFIX =
            "END:VCALENDAR";

        function buildIcsEventString(date, number, unit, icsHash) {
            var summary = number + ' ' + unit;
            var description = 'You are now ' + number + ' ' + unit + ' old!';
            return "BEGIN:VEVENT\n" +
                "UID:test-" + icsHash + "\n" +
                "DTSTART;VALUE=DATE:" +
                convertDate(date) +
                "\n" +
                "DTEND;VALUE=DATE:" +
                convertDate(date) +
                "\n" +
                "SUMMARY:" +
                summary +
                "\n" +
                "DESCRIPTION:" +
                description +
                "\n" +
                "END:VEVENT\n";
        }

        function buildIcsFileFromString(str) {
            var obj = new File([str], { type: "text/plain" });

            // If we are replacing a previously generated file we need to
            // manually revoke the object URL to avoid memory leaks.
            if (ICS_FILE !== null) {
                window.URL.revokeObjectURL(ICS_FILE);
            }

            ICS_FILE = window.URL.createObjectURL(obj);
            return ICS_FILE;
        }
    </script>
</body>

</html>